@page "/settings"
@using System.Net.Http.Json
@using MemoryApp.Contracts
@inject HttpClient Http
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Configuración - VerbMeister</PageTitle>

<div class="container">
    <div class="text-center mb-2">
        <h1>Configuración</h1>
        <p class="text-muted">Ajusta las opciones de la aplicación</p>
    </div>

    @if (!string.IsNullOrEmpty(message))
    {
        <div class="feedback @messageClass mb-1">
            @message
        </div>
    }

    @if (loading)
    {
        <div class="text-center">
            <p>Cargando configuración...</p>
        </div>
    }
    else
    {
        <div class="card">
            <h2>Retroalimentación con IA</h2>
            <p class="text-muted mb-1">
                Habilita comentarios inteligentes generados por un modelo de IA para mejorar tu aprendizaje.
                Cuando respondes incorrectamente, la IA te dará tips personalizados para recordar mejor.
            </p>

            <div class="setting-item">
                <div class="setting-toggle">
                    <label class="toggle-label">
                        <input type="checkbox" @bind="aiFeedbackEnabled" />
                        <span class="toggle-text">Habilitar retroalimentación con IA</span>
                    </label>
                </div>
            </div>

            @if (aiFeedbackEnabled)
            {
                <div class="ai-settings mt-1">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Endpoint de la IA *</label>
                            <input type="text" @bind="aiEndpoint"
                                   placeholder="ej: http://localhost:11434 (Ollama)" />
                            <small class="text-muted">URL del servidor de IA (Ollama, OpenAI, etc.)</small>
                        </div>

                        <div class="form-group">
                            <label>Modelo *</label>
                            <input type="text" @bind="aiModel"
                                   placeholder="ej: llama2, mistral, gpt-4" />
                            <small class="text-muted">Nombre del modelo a usar</small>
                        </div>

                        <div class="form-group">
                            <label>API Key (opcional)</label>
                            <input type="password" @bind="aiApiKey"
                                   placeholder="Solo si el servicio lo requiere" />
                            <small class="text-muted">Requerido para OpenAI y servicios con autenticación</small>
                        </div>

                        <div class="form-group">
                            <label>Timeout (segundos)</label>
                            <input type="number" @bind="aiTimeoutSeconds" min="5" max="120" />
                            <small class="text-muted">Tiempo máximo de espera para respuesta</small>
                        </div>

                        <div class="form-group">
                            <label>Max tokens</label>
                            <input type="number" @bind="aiMaxTokens" min="16" max="2048" />
                            <small class="text-muted">Límite de tokens generados por respuesta</small>
                        </div>

                        <div class="form-group full-width">
                            <label>Prompt del sistema (opcional)</label>
                            <textarea @bind="aiSystemPrompt" rows="4"
                                      placeholder="Instrucciones personalizadas para la IA..."></textarea>
                            <small class="text-muted">Deja vacío para usar el prompt predeterminado</small>
                        </div>
                    </div>

                    <div class="btn-group mt-1">
                        <button class="btn btn-secondary" @onclick="TestConnection" disabled="@testing">
                            @(testing ? "Probando..." : "Probar Conexión")
                        </button>
                    </div>

                    @if (!string.IsNullOrEmpty(testResult))
                    {
                        <div class="test-result mt-1 @testResultClass">
                            @testResult
                        </div>
                    }

                    <div class="info-box mt-1">
                        <h4>Servicios compatibles:</h4>
                        <ul>
                            <li><strong>Ollama (local):</strong> http://localhost:11434</li>
                            <li><strong>OpenAI:</strong> https://api.openai.com (requiere API key)</li>
                            <li><strong>Otros:</strong> Cualquier API compatible con OpenAI</li>
                        </ul>
                    </div>
                </div>
            }
        </div>

        <div class="btn-group mt-2">
            <button class="btn btn-primary" @onclick="SaveSettings" disabled="@saving">
                @(saving ? "Guardando..." : "Guardar Configuración")
            </button>
            <button class="btn btn-secondary" @onclick="GoHome">Volver al Inicio</button>
        </div>
    }
</div>

<style>
    .setting-item {
        padding: 1rem;
        background: var(--bg);
        border-radius: 8px;
    }

    .setting-toggle {
        display: flex;
        align-items: center;
    }

    .toggle-label {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        cursor: pointer;
        font-size: 1rem;
    }

    .toggle-label input[type="checkbox"] {
        width: 1.5rem;
        height: 1.5rem;
        cursor: pointer;
    }

    .toggle-text {
        font-weight: 500;
    }

    .ai-settings {
        padding: 1rem;
        background: var(--bg);
        border-radius: 8px;
        border: 1px solid var(--border);
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .form-group.full-width {
        grid-column: 1 / -1;
    }

    .form-group label {
        font-weight: 500;
        color: var(--text-muted);
        font-size: 0.875rem;
    }

    .form-group input,
    .form-group textarea {
        padding: 0.75rem;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: var(--card-bg);
        color: var(--text);
        font-size: 1rem;
    }

    .form-group input:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: var(--primary);
    }

    .form-group small {
        font-size: 0.75rem;
    }

    .test-result {
        padding: 0.75rem;
        border-radius: 8px;
        font-size: 0.875rem;
    }

    .test-result.success {
        background: rgba(34, 197, 94, 0.15);
        border: 1px solid #22c55e;
        color: #22c55e;
    }

    .test-result.error {
        background: rgba(239, 68, 68, 0.15);
        border: 1px solid #ef4444;
        color: #ef4444;
    }

    .info-box {
        padding: 1rem;
        background: rgba(59, 130, 246, 0.1);
        border: 1px solid var(--primary);
        border-radius: 8px;
    }

    .info-box h4 {
        margin: 0 0 0.5rem 0;
        color: var(--primary);
    }

    .info-box ul {
        margin: 0;
        padding-left: 1.25rem;
    }

    .info-box li {
        margin-bottom: 0.25rem;
    }

    .btn-group {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
    }
</style>

@code {
    private bool loading = true;
    private bool saving = false;
    private bool testing = false;
    private string message = "";
    private string messageClass = "";
    private string testResult = "";
    private string testResultClass = "";

    // Settings fields
    private bool aiFeedbackEnabled = false;
    private string? aiEndpoint = null;
    private string? aiModel = null;
    private string? aiApiKey = null;
    private int aiTimeoutSeconds = 30;
    private int aiMaxTokens = 150;
    private string? aiSystemPrompt = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadSettings();
    }

    private async Task LoadSettings()
    {
        loading = true;
        try
        {
            var response = await Http.GetFromJsonAsync<GetAppSettingsResponse>("/api/v1/settings");
            if (response != null)
            {
                aiFeedbackEnabled = response.Settings.AiFeedbackEnabled;
                aiEndpoint = response.Settings.AiEndpoint;
                aiModel = response.Settings.AiModel;
                aiApiKey = response.Settings.AiApiKey;
                aiTimeoutSeconds = response.Settings.AiTimeoutSeconds;
                aiMaxTokens = response.Settings.AiMaxTokens;
                aiSystemPrompt = response.Settings.AiSystemPrompt;
            }
        }
        catch (Exception ex)
        {
            message = $"Error al cargar configuración: {ex.Message}";
            messageClass = "feedback-error";
        }
        finally
        {
            loading = false;
        }
    }

    private async Task SaveSettings()
    {
        saving = true;
        message = "";

        try
        {
            var request = new UpdateAppSettingsRequest
            {
                AiFeedbackEnabled = aiFeedbackEnabled,
                AiEndpoint = aiEndpoint,
                AiModel = aiModel,
                AiApiKey = aiApiKey,
                AiTimeoutSeconds = aiTimeoutSeconds,
                AiMaxTokens = aiMaxTokens,
                AiSystemPrompt = aiSystemPrompt
            };

            var response = await Http.PutAsJsonAsync("/api/v1/settings", request);
            var result = await response.Content.ReadFromJsonAsync<UpdateAppSettingsResponse>();

            if (result?.Success == true)
            {
                message = "Configuración guardada correctamente";
                messageClass = "feedback-success";
            }
            else
            {
                message = result?.Error ?? "Error al guardar la configuración";
                messageClass = "feedback-error";
            }
        }
        catch (Exception ex)
        {
            message = $"Error: {ex.Message}";
            messageClass = "feedback-error";
        }
        finally
        {
            saving = false;
        }
    }

    private async Task TestConnection()
    {
        if (string.IsNullOrWhiteSpace(aiEndpoint) || string.IsNullOrWhiteSpace(aiModel))
        {
            testResult = "Ingresa el endpoint y el modelo para probar la conexión";
            testResultClass = "error";
            return;
        }

        testing = true;
        testResult = "";

        try
        {
            var request = new TestAiConnectionRequest
            {
                Endpoint = aiEndpoint,
                Model = aiModel,
                ApiKey = aiApiKey,
                TimeoutSeconds = aiTimeoutSeconds,
                MaxTokens = aiMaxTokens
            };

            var response = await Http.PostAsJsonAsync("/api/v1/settings/test-ai", request);
            var result = await response.Content.ReadFromJsonAsync<TestAiConnectionResponse>();

            if (result != null)
            {
                testResult = result.Message;
                testResultClass = result.Success ? "success" : "error";
            }
        }
        catch (Exception ex)
        {
            testResult = $"Error: {ex.Message}";
            testResultClass = "error";
        }
        finally
        {
            testing = false;
        }
    }

    private void GoHome()
    {
        Navigation.NavigateTo("/");
    }
}
