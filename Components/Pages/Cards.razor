@page "/cards"
@using System.Net.Http.Json
@using MemoryApp.Contracts
@inject HttpClient Http
@inject NavigationManager Navigation
@rendermode InteractiveServer
<PageTitle>Tarjetas de Estudio - VerbMeister</PageTitle>

<div class="container">
    @if (loading)
    {
        <div class="text-center mt-2">
            <p>Cargando tarjetas...</p>
        </div>
    }
    else if (cards == null || !cards.Any())
    {
        <div class="text-center mt-2">
            <h2>¡No hay tarjetas disponibles!</h2>
            <p class="text-muted">No hay verbos para repasar en este momento.</p>
            <button class="btn btn-primary mt-1" @onclick="GoHome">Volver al inicio</button>
        </div>
    }
    else
    {
        <div class="mb-2">
            <div class="progress-bar">
                <div class="progress-fill" style="width: @(ProgressPercentage)%"></div>
            </div>
            <p class="text-muted text-center">@currentIndex / @cards.Count</p>
        </div>

        @if (currentCard != null)
        {
            <div class="flash-card @(isFlipped ? "flash-card-back" : "flash-card-front")" @onclick="FlipCard">
                @if (!isFlipped)
                {
                    <div>
                        <p class="text-muted">Alemán → Español</p>
                        <div class="verb">@currentCard.Infinitive</div>
                        <p class="text-muted" style="font-size: 0.875rem;">Toca para voltear</p>
                    </div>
                }
                else
                {
                    <div>
                        <div class="translation">@currentCard.TranslationEs</div>
                        <div class="details">
                            <div class="detail-item"><strong>Partizip II:</strong> @currentCard.PartizipII</div>
                            <div class="detail-item"><strong>Auxiliar:</strong> @currentCard.Auxiliary</div>
                            @if (currentCard.IsSeparable)
                            {
                                <div class="detail-item"><strong>Separable:</strong> @currentCard.Prefix</div>
                            }
                            @if (!string.IsNullOrEmpty(currentCard.Notes))
                            {
                                <div class="detail-item" style="margin-top: 1rem; font-style: italic;">@currentCard.Notes</div>
                            }
                        </div>
                    </div>
                }
            </div>

            @if (isFlipped)
            {
                <div class="btn-group mt-2">
                    <button class="btn btn-accent" @onclick='() => RateCard("know")'>✓ Lo sé</button>
                    <button class="btn btn-secondary" @onclick='() => RateCard("doubt")'>~ Dudé</button>
                    <button class="btn btn-error" @onclick='() => RateCard("dontknow")'>✗ No lo sé</button>
                </div>
            }

            @if (!string.IsNullOrEmpty(feedback))
            {
                <div class="feedback @feedbackClass mt-1">
                    @feedback
                </div>
            }
        }
    }
</div>

@code {
    [SupplyParameterFromQuery(Name = "level")]
    public string? Level { get; set; }

    private List<CardDto> cards = new();
    private CardDto? currentCard;
    private int currentIndex = 1;
    private bool isFlipped = false;
    private bool loading = true;
    private string feedback = "";
    private string feedbackClass = "";
    private Guid sessionId;

    protected override async Task OnInitializedAsync()
    {
        await LoadSession();
    }

    private async Task LoadSession()
    {
        loading = true;
        try
        {
            var level = Level ?? "A1";
            var response = await Http.GetFromJsonAsync<GetCardsSessionResponse>(
                $"/api/v1/modes/cards/session?level={level}&type=review&count=20");

            if (response != null)
            {
                sessionId = response.SessionId;
                cards = response.Cards;
                if (cards.Any())
                {
                    currentCard = cards[0];
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading session: {ex.Message}");
        }
        finally
        {
            loading = false;
        }
    }

    private void FlipCard()
    {
        isFlipped = !isFlipped;
    }

    private async Task RateCard(string rating)
    {
        if (currentCard == null) return;

        try
        {
            var request = new RateCardRequest
            {
                SessionId = sessionId,
                VerbId = currentCard.VerbId,
                Rating = rating
            };

            var response = await Http.PostAsJsonAsync("/api/v1/modes/cards/rate", request);
            var result = await response.Content.ReadFromJsonAsync<RateCardResponse>();

            if (result != null)
            {
                feedback = result.Message;
                feedbackClass = rating == "know" ? "feedback-success" : (rating == "doubt" ? "feedback-info" : "feedback-error");

                await Task.Delay(1500); // Show feedback briefly

                // Move to next card
                if (currentIndex < cards.Count)
                {
                    currentIndex++;
                    currentCard = cards[currentIndex - 1];
                    isFlipped = false;
                    feedback = "";
                }
                else
                {
                    // Session complete
                    Navigation.NavigateTo($"/progress?level={Level ?? "A1"}");
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error rating card: {ex.Message}");
            feedback = "Error al guardar. Intenta de nuevo.";
            feedbackClass = "feedback-error";
        }
    }

    private void GoHome()
    {
        Navigation.NavigateTo("/");
    }

    private double ProgressPercentage => cards.Any() ? ((double)currentIndex / cards.Count) * 100 : 0;
}
