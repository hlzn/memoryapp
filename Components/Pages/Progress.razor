@page "/progress"
@using System.Net.Http.Json
@using MemoryApp.Contracts
@inject HttpClient Http
@inject NavigationManager Navigation

<PageTitle>Mi Progreso - VerbMeister</PageTitle>

<div class="container">
    <div class="mb-2">
        <h1>Mi Progreso</h1>
        <div class="level-selector">
            <button class="level-btn @(selectedLevel == "A1" ? "active" : "")" @onclick='() => ChangeLevel("A1")'>A1</button>
            <button class="level-btn @(selectedLevel == "A2" ? "active" : "")" @onclick='() => ChangeLevel("A2")'>A2</button>
            <button class="level-btn @(selectedLevel == "B1" ? "active" : "")" @onclick='() => ChangeLevel("B1")'>B1</button>
            <button class="level-btn @(selectedLevel == "B2" ? "active" : "")" @onclick='() => ChangeLevel("B2")'>B2</button>
        </div>
    </div>

    @if (loading)
    {
        <div class="text-center">
            <p>Cargando estadísticas...</p>
        </div>
    }
    else if (progress != null)
    {
        <div class="card">
            <h2>Resumen de Nivel @progress.Level</h2>
            <div class="progress-bar mt-1">
                <div class="progress-fill" style="width: @MasteryPercentage%"></div>
            </div>
            <p class="text-center text-muted">Dominio promedio: @progress.AverageMastery%</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">@progress.TotalVerbs</div>
                <div class="stat-label">Verbos Totales</div>
            </div>

            <div class="stat-card">
                <div class="stat-value" style="color: var(--color-accent)">@progress.MasteredVerbs</div>
                <div class="stat-label">Dominados (≥80%)</div>
            </div>

            <div class="stat-card">
                <div class="stat-value" style="color: var(--color-primary)">@progress.LearningVerbs</div>
                <div class="stat-label">En Aprendizaje</div>
            </div>

            <div class="stat-card">
                <div class="stat-value" style="color: #999">@progress.NewVerbs</div>
                <div class="stat-label">Nuevos</div>
            </div>

            <div class="stat-card">
                <div class="stat-value">@progress.TotalAttempts</div>
                <div class="stat-label">Intentos Totales</div>
            </div>

            <div class="stat-card">
                <div class="stat-value" style="color: var(--color-accent)">@progress.AccuracyRate%</div>
                <div class="stat-label">Tasa de Acierto</div>
            </div>
        </div>

        <div class="btn-group mt-2">
            <button class="btn btn-primary" @onclick="ContinuePractice">Continuar Practicando</button>
            <button class="btn btn-secondary" @onclick="GoHome">Volver al Inicio</button>
        </div>
    }
</div>

@code {
    [SupplyParameterFromQuery(Name = "level")]
    public string? Level { get; set; }

    private string selectedLevel = "A1";
    private ProgressOverviewResponse? progress;
    private bool loading = true;

    protected override async Task OnInitializedAsync()
    {
        selectedLevel = Level ?? "A1";
        await LoadProgress();
    }

    private async Task LoadProgress()
    {
        loading = true;
        try
        {
            progress = await Http.GetFromJsonAsync<ProgressOverviewResponse>(
                $"/api/v1/progress/overview?level={selectedLevel}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading progress: {ex.Message}");
        }
        finally
        {
            loading = false;
        }
    }

    private async Task ChangeLevel(string level)
    {
        selectedLevel = level;
        await LoadProgress();
    }

    private void ContinuePractice()
    {
        Navigation.NavigateTo($"/cards?level={selectedLevel}");
    }

    private void GoHome()
    {
        Navigation.NavigateTo("/");
    }

    private double MasteryPercentage => progress?.AverageMastery ?? 0;
}
